<?xml version="1.0"?>
<robot name="husky" xmlns:xacro="http://ros.org/wiki/xacro">

  <!-- Define a macro so we can reuse this model -->
  <xacro:macro name="husky" params="">
  <xacro:property name="husky_mesh_prefix"
    value="package://husky_panda_description/husky_panda_model/panda_mounted_husky/husky_robot_description/meshes"/>

      <!-- =========================
          LINKS
          ========================= -->
      <!-- base_link -->
      <link name="base_link">
        <inertial>
          <origin xyz="-0.000543 -0.084945 0.062329" rpy="0 0 0"/>
          <mass value="46.064"/>
          <inertia
            ixx="0.615397" ixy="-0.0240585" ixz="-0.120749"
            iyy="1.75388"  iyz="-0.0028322" izz="2.03641"/>
        </inertial>

        <!-- <joint name="base_footprint_joint" type="fixed">
            <parent link="base_link"/>
            <child link="base_footprint"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </joint>

        <link name="base_footprint">
        </link> -->

        <!-- Collisions -->
        <collision name="base_link_collision">
          <origin xyz="0 0 0.12" rpy="0 0 0"/>
          <geometry>
            <box size="0.9874 0.5709 0.05"/>
          </geometry>
        </collision>

        <collision name="base_link_collision_bottom">
          <origin xyz="0 0 0.046" rpy="0 0 0"/>
          <geometry>
            <box size="0.80 0.5709 0.095"/>
          </geometry>
        </collision>

        <collision name="base_link_collision_1">
          <origin xyz="0 0 0.185625" rpy="0 0 0"/>
          <geometry>
            <box size="0.78992 0.5709 0.12375"/>
          </geometry>
        </collision>

        <collision name="sensor_tower_collision">
          <origin xyz="0.374 0 0.215" rpy="0 0 0"/>
          <geometry>
            <box size="0.2 0.25 0.225"/>
          </geometry>
        </collision>

        <collision name="landing_pad_collision">
          <origin xyz="0.0 0 0.155" rpy="0 0 0"/>
          <geometry>
            <box size="0.500 0.385 0.155"/>
          </geometry>
        </collision>

        <!-- Visuals -->
        <visual name="base_link_visual">
          <origin xyz="0 0 0" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/base_link.dae" scale="1 1 1"/>
          </geometry>
        </visual>

        <!-- <visual name="front_bumper_visual">
          <origin xyz="0.48 0 0.091" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/bumper.dae"/>
          </geometry>
        </visual> -->

        <!-- <visual name="rear_bumper_visual">
          <origin xyz="-0.48 0 0.091" rpy="0 0 3.14159"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/bumper.dae"/>
          </geometry>
        </visual> -->

        <visual name="top_chassis_visual">
          <origin xyz="0 0 0" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/top_chassis.dae"/>
          </geometry>
        </visual>

        <visual name="velodyne_base_visual_1">
          <origin xyz="0.424 0 0.327" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/VLP16_base_1.dae"/>
          </geometry>
        </visual>

        <visual name="velodyne_base_visual_2">
          <origin xyz="0.424 0 0.327" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/VLP16_base_2.dae"/>
          </geometry>
        </visual>

        <visual name="velodyne_scan_visual">
          <origin xyz="0.424 0 0.327" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/VLP16_scan.dae"/>
          </geometry>
        </visual>

        <visual name="user_rail_visual">
          <origin xyz="0.272 0 0.245" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/user_rail.dae"/>
          </geometry>
        </visual>

        <visual name="planar_lidar_visual">
          <!-- <origin xyz="0.474 0 0.127" rpy="0 0 0"/> -->
            <!-- was: 0.474 0 0.127 0 0 0 -->
          <origin xyz="0.474 0 0.127" rpy="0 0 0"/>
          <geometry>
            <cylinder radius="0.045" length="0.05"/>
          </geometry>
        </visual>

        <visual name="sensor_tower_visual">
          <origin xyz="0.374 0 0.215" rpy="0 0 0"/>
          <geometry>
            <box size="0.2 0.25 0.225"/>
          </geometry>
        </visual>

        <visual name="landing_pad_visual">
          <origin xyz="0.0 0 0.155" rpy="0 0 0"/>
          <geometry>
            <box size="0.500 0.385 0.155"/>
          </geometry>
        </visual>

        <visual name="base_realsense_down_visual">
          <origin xyz="0.478 0 0.260" rpy="0 -0.035 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/realsense.dae"/>
          </geometry>
        </visual>

        <visual name="base_realsense_front_visual">
          <origin xyz="0.478 0 0.285" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/realsense.dae"/>
          </geometry>
        </visual>
      </link>

      <!-- front_left_wheel_link -->
      <link name="front_left_wheel_link">
        <inertial>
          <origin xyz="0 0 0"/>
          <mass value="2.637"/>
          <inertia ixx="0.02467" iyy="0.04411" izz="0.02467" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <origin xyz="0 0 0" rpy="1.5707963267948966 0 0"/>
          <geometry>
            <cylinder radius="0.1651" length="0.1143"/>
          </geometry>
        </collision>
        <visual>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/wheel.dae"/>
          </geometry>
        </visual>
      </link>

      <!-- front_right_wheel_link -->
      <link name="front_right_wheel_link">
        <inertial>
          <origin xyz="0 0 0"/>
          <mass value="2.637"/>
          <inertia ixx="0.02467" iyy="0.04411" izz="0.02467" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <origin xyz="0 0 0" rpy="1.5707963267948966 0 0"/>
          <geometry>
            <cylinder radius="0.1651" length="0.1143"/>
          </geometry>
        </collision>
        <visual>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/wheel.dae"/>
          </geometry>
        </visual>
      </link>

      <!-- rear_left_wheel_link -->
      <link name="rear_left_wheel_link">
        <inertial>
          <origin xyz="0 0 0"/>
          <mass value="2.637"/>
          <inertia ixx="0.02467" iyy="0.04411" izz="0.02467" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <origin xyz="0 0 0" rpy="1.5707963267948966 0 0"/>
          <geometry>
            <cylinder radius="0.1651" length="0.1143"/>
          </geometry>
        </collision>
        <visual>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/wheel.dae"/>
          </geometry>
        </visual>
      </link>

      <!-- rear_right_wheel_link -->
      <link name="rear_right_wheel_link">
        <inertial>
          <origin xyz="0 0 0"/>
          <mass value="2.637"/>
          <inertia ixx="0.02467" iyy="0.04411" izz="0.02467" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <origin xyz="0 0 0" rpy="1.5707963267948966 0 0"/>
          <geometry>
            <cylinder radius="0.1651" length="0.1143"/>
          </geometry>
        </collision>
        <visual>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/wheel.dae"/>
          </geometry>
        </visual>
      </link>

      <!-- pan_gimbal_link -->
      <link name="pan_gimbal_link">
        <inertial>
          <origin xyz="0 0 0"/>
          <mass value="0.1"/>
          <inertia ixx="0.000016875" iyy="1e-8" izz="0.000016875" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <geometry>
            <cylinder radius="0.014" length="0.045"/>
          </geometry>
        </collision>
        <visual>
          <geometry>
            <cylinder radius="0.014" length="0.045"/>
          </geometry>
        </visual>
      </link>

      <!-- tilt_gimbal_link -->
      <link name="tilt_gimbal_link">
        <inertial>
          <origin xyz="0 0 0" rpy="1.570796 0 0"/>
          <mass value="0.1"/>
          <inertia ixx="0.000016875" iyy="1e-8" izz="0.000016875" ixy="0" ixz="0" iyz="0"/>
        </inertial>
        <collision>
          <origin rpy="1.570796 0 0"/>
          <geometry>
            <cylinder radius="0.014" length="0.045"/>
          </geometry>
        </collision>
        <visual>
          <origin rpy="1.570796 0 0"/>
          <geometry>
            <cylinder radius="0.014" length="0.045"/>
          </geometry>
        </visual>

        <!-- Extra visuals on tilt gimbal -->
        <visual name="tilt_realsense_visual">
          <origin xyz="0.0 0 0.03" rpy="0 0 0"/>
          <geometry>
            <mesh filename="${husky_mesh_prefix}/realsense.dae"/>
          </geometry>
        </visual>
        <visual name="bot_camera_plate_low">
          <origin xyz="0 0 0.017"/>
          <geometry>
            <box size="0.025 0.13 0.007"/>
          </geometry>
        </visual>
        <visual name="bot_camera_plate_high">
          <origin xyz="0 0 0.042"/>
          <geometry>
            <box size="0.025 0.13 0.007"/>
          </geometry>
        </visual>
      </link>

      <!-- planar_lidar_link -->
      <link name="planar_lidar_link"/>

      <!-- =========================
          JOINTS
          ========================= -->
      <joint name="front_left_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="front_left_wheel_link"/>
        <origin xyz="0.256 0.2854 0.03282" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
      </joint>

      <joint name="front_right_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="front_right_wheel_link"/>
        <origin xyz="0.256 -0.2854 0.03282" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
      </joint>

      <joint name="rear_left_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="rear_left_wheel_link"/>
        <origin xyz="-0.256 0.2854 0.03282" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
      </joint>

      <joint name="rear_right_wheel_joint" type="continuous">
        <parent link="base_link"/>
        <child link="rear_right_wheel_link"/>
        <origin xyz="-0.256 -0.2854 0.03282" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
      </joint>

      <joint name="pan_gimbal_joint" type="continuous">
        <parent link="base_link"/>
        <child link="pan_gimbal_link"/>
        <origin xyz="0.424 0 0.427" rpy="0 0 0"/>
        <axis xyz="0 0 1"/>
      </joint>

      <joint name="tilt_gimbal_joint" type="revolute">
        <parent link="pan_gimbal_link"/>
        <child link="tilt_gimbal_link"/>
        <origin xyz="0 0 0.033" rpy="0 0 0"/>
        <axis xyz="0 1 0"/>
        <limit lower="-1.5708" upper="1.5708" effort="10" velocity="10"/>
      </joint>

      <!-- =========================
          GAZEBO / IGNITION
          ========================= -->
      <!-- Sensors mounted on base_link -->
      <gazebo reference="base_link">
        <!-- camera_front -->
        <sensor name="camera_front" type="rgbd_camera">
          <topic>camera_front</topic>
          <pose>0.468 0 0.360 0 0 0</pose>
          <update_rate>30</update_rate>
          <camera name="camera_front">
            <horizontal_fov>1.5184</horizontal_fov>
            <lens>
              <intrinsics>
                <fx>168.61097</fx>
                <fy>168.61097</fy>
                <cx>160.5</cx>
                <cy>120.5</cy>
                <s>0</s>
              </intrinsics>
            </lens>
            <distortion>
              <k1>0</k1><k2>0</k2><k3>0</k3><p1>0</p1><p2>0</p2>
              <center>0.5 0.5</center>
            </distortion>
            <image>
              <width>320</width><height>240</height><format>R8G8B8</format>
            </image>
            <clip><near>0.01</near><far>300</far></clip>
            <depth_camera><clip><near>0.1</near><far>10</far></clip></depth_camera>
            <noise><type>gaussian</type><mean>0</mean><stddev>0.007</stddev></noise>
          </camera>
        </sensor>

        <!-- camera_down -->
        <sensor name="camera_down" type="rgbd_camera">
          <topic>camera_down</topic>
          <pose>0.468 0 0.335 0 0.5236 0</pose>
          <update_rate>30</update_rate>
          <camera name="camera_down">
            <horizontal_fov>1.5184</horizontal_fov>
            <lens>
              <intrinsics>
                <fx>168.61097</fx><fy>168.61097</fy>
                <cx>160.5</cx><cy>120.5</cy><s>0</s>
              </intrinsics>
            </lens>
            <distortion>
              <k1>0</k1><k2>0</k2><k3>0</k3><p1>0</p1><p2>0</p2>
              <center>0.5 0.5</center>
            </distortion>
            <image>
              <width>320</width><height>240</height><format>R8G8B8</format>
            </image>
            <clip><near>0.01</near><far>300</far></clip>
            <depth_camera><clip><near>0.1</near><far>10</far></clip></depth_camera>
            <noise><type>gaussian</type><mean>0</mean><stddev>0.007</stddev></noise>
          </camera>
        </sensor>

        <!-- planar 2D lidar -->
        <sensor name="planar_laser" type="gpu_ray">
        <topic>planar_laser</topic>
          <!-- <pose>0.474 0 0.127 0 0 0</pose> -->
          <pose>0.474 0 0.127 0 0 0</pose>
          <update_rate>10</update_rate>
          <lidar>
            <scan>
              <horizontal>
                <samples>1600</samples>
                <resolution>1</resolution>
                <min_angle>-3.14159</min_angle>
                <max_angle>3.14159</max_angle>
              </horizontal>
            </scan>
            <range>
              <min>0.60</min>
              <max>25.0</max>
              <resolution>0.01</resolution>
            </range>
            <noise><type>gaussian</type><mean>0</mean><stddev>0.01</stddev></noise>
          </lidar>
        </sensor>

        <!-- front 3D lidar -->
        <sensor name="front_laser" type="gpu_lidar">
          <topic>front_laser</topic>
          <pose>0.424 0 0.387 0 0 0</pose>
          <update_rate>20</update_rate>
          <lidar>
            <scan>
              <horizontal>
                <samples>1024</samples>
                <resolution>1</resolution>
                <min_angle>-3.14159</min_angle>
                <max_angle>3.14159</max_angle>
              </horizontal>
              <vertical>
                <samples>64</samples>
                <resolution>1</resolution>
                <min_angle>-0.2897</min_angle>
                <max_angle>0.2897</max_angle>
              </vertical>
            </scan>
            <range><min>0.8</min><max>120</max><resolution>0.003</resolution></range>
            <noise><type>gaussian</type><mean>0</mean><stddev>0.03</stddev></noise>
          </lidar>
        </sensor>

        <!-- IMU -->
        <sensor name="imu_sensor" type="imu">
          <topic>/imu_sensor</topic>
          <pose>0 0 0 0 0 0</pose>
          <update_rate>50</update_rate>
          <imu>
            <angular_velocity>
              <x>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.009</stddev>
                  <bias_mean>0.00075</bias_mean><bias_stddev>0.005</bias_stddev>
                  <dynamic_bias_stddev>0.00002</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>400.0</dynamic_bias_correlation_time>
                  <precision>0.00025</precision>
                </noise>
              </x>
              <y>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.009</stddev>
                  <bias_mean>0.00075</bias_mean><bias_stddev>0.005</bias_stddev>
                  <dynamic_bias_stddev>0.00002</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>400.0</dynamic_bias_correlation_time>
                  <precision>0.00025</precision>
                </noise>
              </y>
              <z>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.009</stddev>
                  <bias_mean>0.00075</bias_mean><bias_stddev>0.005</bias_stddev>
                  <dynamic_bias_stddev>0.00002</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>400.0</dynamic_bias_correlation_time>
                  <precision>0.00025</precision>
                </noise>
              </z>
            </angular_velocity>
            <linear_acceleration>
              <x>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.021</stddev>
                  <bias_mean>0.05</bias_mean><bias_stddev>0.0075</bias_stddev>
                  <dynamic_bias_stddev>0.000375</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>175.0</dynamic_bias_correlation_time>
                  <precision>0.005</precision>
                </noise>
              </x>
              <y>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.021</stddev>
                  <bias_mean>0.05</bias_mean><bias_stddev>0.0075</bias_stddev>
                  <dynamic_bias_stddev>0.000375</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>175.0</dynamic_bias_correlation_time>
                  <precision>0.005</precision>
                </noise>
              </y>
              <z>
                <noise type="gaussian">
                  <mean>0</mean><stddev>0.021</stddev>
                  <bias_mean>0.05</bias_mean><bias_stddev>0.0075</bias_stddev>
                  <dynamic_bias_stddev>0.000375</dynamic_bias_stddev>
                  <dynamic_bias_correlation_time>175.0</dynamic_bias_correlation_time>
                  <precision>0.005</precision>
                </noise>
              </z>
            </linear_acceleration>
          </imu>
        </sensor>
      </gazebo>

      <!-- Controllers & systems -->
      <gazebo>
        <plugin filename="libgz-sim-diff-drive-system.so"
              name="gz::sim::systems::DiffDrive">
          <left_joint>front_left_wheel_joint</left_joint>
          <left_joint>rear_left_wheel_joint</left_joint>
          <right_joint>front_right_wheel_joint</right_joint>
          <right_joint>rear_right_wheel_joint</right_joint>
          <wheel_radius>0.1651</wheel_radius>
          <wheel_separation>0.5708</wheel_separation>
          <topic>cmd_vel</topic>
          <odom_topic>odom</odom_topic>
          <frame_id>odom</frame_id>
          <child_frame_id>base_link</child_frame_id>
          <max_linear_acceleration>3.0</max_linear_acceleration>
          <max_angular_acceleration>6.0</max_angular_acceleration>
          <min_velocity>-2.0</min_velocity>
          <max_velocity>2.0</max_velocity>
          <min_angular_velocity>-3.0</min_angular_velocity>
          <max_angular_velocity>3.0</max_angular_velocity>
          <odom_publish_frequency>50</odom_publish_frequency>
          <use_velocity_commands>true</use_velocity_commands>
        </plugin>

        <plugin filename="libgz-sim-joint-controller-system.so"
              name="gz::sim::systems::JointController">     
              <joint_name>pan_gimbal_joint</joint_name>
          <use_force_commands>true</use_force_commands>
          <p_gain>0.4</p_gain>
          <i_gain>10</i_gain>
        </plugin>

        <plugin filename="libgz-sim-joint-controller-system.so"
              name="gz::sim::systems::JointController">
          <joint_name>tilt_gimbal_joint</joint_name>
          <use_force_commands>true</use_force_commands>
          <p_gain>0.4</p_gain>
          <i_gain>10</i_gain>
        </plugin>

        <plugin filename="libgz-sim-joint-state-publisher-system.so"
              name="gz::sim::systems::JointStatePublisher">
          <joint_name>front_left_wheel_joint</joint_name>
          <joint_name>front_right_wheel_joint</joint_name>
          <joint_name>rear_left_wheel_joint</joint_name>
          <joint_name>rear_right_wheel_joint</joint_name>
          <joint_name>pan_gimbal_joint</joint_name>
          <joint_name>tilt_gimbal_joint</joint_name>
        </plugin>
      </gazebo>

      <!-- Camera Front -->
      <link name="camera_front_link"/>
      <joint name="camera_front_joint" type="fixed">
        <parent link="base_link"/>
        <child link="camera_front_link"/>
        <origin xyz="0.468 0 0.360" rpy="0 0 0"/>
      </joint>

      <!-- Camera Down -->
      <link name="camera_down_link"/>
      <joint name="camera_down_joint" type="fixed">
        <parent link="base_link"/>
        <child link="camera_down_link"/>
        <origin xyz="0.468 0 0.335" rpy="0 0.5236 0"/>
      </joint>

      <!-- Front 3D Lidar -->
      <link name="front_laser_link"/>
      <joint name="front_laser_joint" type="fixed">
        <parent link="base_link"/>
        <child link="front_laser_link"/>
        <origin xyz="0.424 0 0.387" rpy="0 0 0"/>
      </joint>

      <!-- IMU -->
      <link name="imu_link"/>
      <joint name="imu_joint" type="fixed">
        <parent link="base_link"/>
        <child link="imu_link"/>
        <origin xyz="0 0 0" rpy="0 0 0"/>
      </joint>


        <!-- planar_lidar_joint -->
      <joint name="planar_lidar_joint" type="fixed">
        <parent link="base_link"/>
        <child link="planar_lidar_link"/>
        <!-- <origin xyz="0.474 0 0.127" rpy="0 0 0"/> -->
        <origin xyz="0.474 0 0.127" rpy="0 0 0"/>
      </joint>

      <!-- Example for front_left_wheel_link -->
      <gazebo reference="front_left_wheel_link">
        <mu1>2.0</mu1>
        <mu2>2.0</mu2>
        <surface>
          <friction>
            <ode>
              <mu>2.0</mu>
              <mu2>2.0</mu2>
            </ode>
          </friction>
        </surface>
      </gazebo>

      <gazebo reference="front_right_wheel_link">
        <mu1>2.0</mu1>
        <mu2>2.0</mu2>
        <surface>
          <friction>
            <ode>
              <mu>2.0</mu>
              <mu2>2.0</mu2>
            </ode>
          </friction>
        </surface>
      </gazebo>

      <gazebo reference="rear_left_wheel_link">
        <mu1>2.0</mu1>
        <mu2>2.0</mu2>
        <surface>
          <friction>
            <ode>
              <mu>2.0</mu>
              <mu2>2.0</mu2>
            </ode>
          </friction>
        </surface>
      </gazebo>

      <gazebo reference="rear_right_wheel_link">
        <mu1>2.0</mu1>
        <mu2>2.0</mu2>
        <surface>
          <friction>
            <ode>
              <mu>2.0</mu>
              <mu2>2.0</mu2>
            </ode>
          </friction>
        </surface>
      </gazebo>

  </xacro:macro>
</robot>